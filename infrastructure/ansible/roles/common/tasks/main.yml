# Common Role - Basic server configuration
# This role sets up the basic server configuration that all hosts need.

---
- name: Set timezone
  community.general.timezone:
    name: "{{ timezone }}"

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: safe
  when: upgrade_packages | default(true)

- name: Install system packages
  ansible.builtin.apt:
    name: "{{ system_packages }}"
    state: present

- name: Create application user
  ansible.builtin.user:
    name: "{{ app_user }}"
    shell: /bin/bash
    groups: sudo
    append: true
    create_home: true

- name: Add application user to docker group
  ansible.builtin.user:
    name: "{{ app_user }}"
    groups: docker
    append: true
  when: "'docker' in ansible_facts.getent_group | default({})"

- name: Create application directory
  ansible.builtin.file:
    path: "{{ app_path }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: "0755"

- name: Create secrets directory
  ansible.builtin.file:
    path: "{{ app_path }}/secrets"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: "0700"

- name: Configure automatic security updates
  ansible.builtin.apt:
    name: unattended-upgrades
    state: present

- name: Enable automatic security updates
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
      APT::Periodic::AutocleanInterval "7";
    mode: "0644"

- name: Configure unattended upgrades for security only
  ansible.builtin.copy:
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    content: |
      Unattended-Upgrade::Allowed-Origins {
          "${distro_id}:${distro_codename}-security";
      };
      Unattended-Upgrade::AutoFixInterruptedDpkg "true";
      Unattended-Upgrade::Remove-Unused-Dependencies "true";
      Unattended-Upgrade::Automatic-Reboot "false";
    mode: "0644"




