# Bisect Bot Infrastructure

Infrastructure as Code for deploying Bisect Bot to Hetzner Cloud.

## Quick Start

```bash
# 1. Configure secrets (one file)
cp secrets.example.yml secrets.yml
# Edit secrets.yml with your credentials

# 2. Create server
cd terraform
terraform init
terraform apply -var-file=../secrets.yml

# 3. Deploy app
cd ../ansible
ansible-playbook site.yml
```

## Directory Structure

```
infrastructure/
├── secrets.example.yml     # Template for your secrets (copy to secrets.yml)
├── secrets.yml             # YOUR SECRETS (never commit!)
│
├── terraform/              # Hetzner Cloud provisioning
│   └── main.tf            # Server, firewall, SSH keys
│
└── ansible/               # Server configuration
    ├── site.yml           # Main deployment playbook
    ├── inventory/hosts    # Auto-generated by Terraform
    └── group_vars/
        ├── all.yml        # Non-secret config
        └── vault.yml      # Auto-generated from secrets.yml
```

## What Gets Created

### Terraform (Hetzner)

- **Server:** Ubuntu 24.04 on CX32 (4 vCPU, 8GB RAM)
- **Firewall:** SSH (22), HTTP (80), HTTPS (443)
- **SSH Key:** For passwordless access

### Ansible (Server Config)

- Docker & Docker Compose
- UFW firewall & fail2ban
- Application code & dependencies
- Caddy reverse proxy with auto-SSL
- Database migrations
- Auto-scaling cron job (every 5 min)
- Daily backup cron job (2 AM)

## Requirements

```bash
# macOS
brew install terraform ansible

# Linux
pip install ansible
# Install Terraform from https://terraform.io/downloads
```

## Configuration Reference

See `secrets.example.yml` for all available options:

| Setting | Required | Description |
|---------|----------|-------------|
| `hcloud_token` | ✅ | Hetzner API token |
| `ssh_public_key` | ✅ | Your SSH public key |
| `domain` | ✅ | Your domain name |
| `database_url` | ✅ | Supabase pooled connection |
| `github_app_id` | ✅ | GitHub App ID |
| `github_private_key` | ✅ | GitHub App private key |
| `server_type` | ❌ | Server size (default: cx32) |
| `worker_replicas` | ❌ | Number of workers (default: 2) |

## Commands

```bash
# Preview infrastructure changes
terraform plan -var-file=../secrets.yml

# Apply infrastructure changes
terraform apply -var-file=../secrets.yml

# Deploy/update application
ansible-playbook site.yml

# Destroy everything
terraform destroy -var-file=../secrets.yml
```

## Security Notes

**Never commit these files:**
- `secrets.yml`
- `ansible/group_vars/vault.yml`
- `ansible/inventory/hosts`
- `*.tfstate*`

These are in `.gitignore` but always double-check before committing.
